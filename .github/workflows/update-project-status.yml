name: Update Project Status

# Update project status based on PR state
on:
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [closed, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  update-status:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: Update project item status
    steps:
      - name: Update Project Status
        env:
          GH_TOKEN: ${{ secrets.GH_PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          EVENT_ACTION: ${{ github.event.action }}
          PROJECT_NUMBER: ${{ vars.GITHUB_PROJECT_NUMBER || '1' }}
        run: |
          # Determine target status based on event action
          case "$EVENT_ACTION" in
            opened)    STATUS="Todo" ;;
            closed)    STATUS="Done" ;;
            reopened)  STATUS="In Progress" ;;
            *)         echo "No status mapping for action: $EVENT_ACTION"; exit 0 ;;
          esac

          echo "Updating issue/PR #$ISSUE_NUMBER status to: $STATUS"

          OWNER=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
          REPO=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2)

          # Find the project item for this issue/PR
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issueOrPullRequest(number: $number) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes { id }
                    }
                  }
                  ... on PullRequest {
                    projectItems(first: 10) {
                      nodes { id }
                    }
                  }
                }
              }
            }' -f owner="$OWNER" -f repo="$REPO" -F number="$ISSUE_NUMBER" \
            --jq '.data.repository.issueOrPullRequest.projectItems.nodes[0].id' 2>/dev/null || echo "")

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            echo "Item #$ISSUE_NUMBER not found in any project. Skipping."
            exit 0
          fi

          echo "Found project item: $ITEM_ID"

          # Get project ID and Status field info
          PROJECT_DATA=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      id
                      options { id name }
                    }
                  }
                }
              }
            }' -f owner="$OWNER" -F number="$PROJECT_NUMBER" 2>/dev/null || echo "")

          if [ -z "$PROJECT_DATA" ]; then
            echo "Could not fetch project data. Skipping."
            exit 0
          fi

          PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.data.user.projectV2.id // empty')
          FIELD_ID=$(echo "$PROJECT_DATA" | jq -r '.data.user.projectV2.field.id // empty')
          OPTION_ID=$(echo "$PROJECT_DATA" | jq -r --arg status "$STATUS" '.data.user.projectV2.field.options[] | select(.name == $status) | .id // empty')

          if [ -z "$PROJECT_ID" ] || [ -z "$FIELD_ID" ] || [ -z "$OPTION_ID" ]; then
            echo "Could not resolve project/field/option IDs (project=$PROJECT_ID, field=$FIELD_ID, option=$OPTION_ID). Skipping."
            exit 0
          fi

          # Update the status field
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: { singleSelectOptionId: $optionId }
              }) {
                projectV2Item { id }
              }
            }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$FIELD_ID" -f optionId="$OPTION_ID"

          echo "Updated #$ISSUE_NUMBER status to: $STATUS"
