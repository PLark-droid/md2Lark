name: "\U0001F504 State Machine"

# Automatically manage Issue/PR state based on labels
# Constitutional requirement: "Labels are the OS's state management"

on:
  issues:
    types: [opened, labeled, unlabeled, assigned, closed, reopened]
  pull_request:
    types: [opened, labeled, unlabeled, closed, reopened, ready_for_review]
  issue_comment:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

permissions:
  issues: write
  pull-requests: write

jobs:
  # ==========================================================================
  # 1. Initial Triage - New Issues
  # ==========================================================================

  initial-triage:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'issues' && github.event.action == 'opened'
    name: Initial Triage

    steps:
      - name: Set initial state to pending
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.name;

            // Remove any existing state: labels
            const currentLabels = issue.labels.map(l => l.name);
            for (const label of currentLabels) {
              if (label.includes('state:')) {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: issue.number,
                  name: label,
                }).catch(() => {});
              }
            }

            // Add pending state
            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: issue.number,
              labels: ['state:pending'],
            });

            console.log(`Issue #${issue.number}: state -> pending (New issue created, awaiting triage)`);

      - name: Auto-assign priority
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            let priority = 'priority:P2-Medium';

            // Check for priority indicators in title/body
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();

            if (title.includes('critical') || body.includes('production down') || body.includes('security')) {
              priority = 'priority:P0-Critical';
            } else if (title.includes('urgent') || title.includes('bug') || body.includes('broken')) {
              priority = 'priority:P1-High';
            } else if (title.includes('enhancement') || title.includes('feature')) {
              priority = 'priority:P2-Medium';
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              labels: [priority]
            });

  # ==========================================================================
  # 2. Coordinator Assignment - Trigger Analysis
  # ==========================================================================

  coordinator-assignment:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'agent:coordinator')
    name: Coordinator Assignment

    steps:
      - name: Transition to analyzing
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.name;

            for (const label of issue.labels.map(l => l.name)) {
              if (label.includes('state:')) {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: issue.number,
                  name: label,
                }).catch(() => {});
              }
            }

            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: issue.number,
              labels: ['state:analyzing'],
            });

            console.log(`Issue #${issue.number}: state -> analyzing (CoordinatorAgent assigned)`);

  # ==========================================================================
  # 3. Specialist Assignment - Start Implementation
  # ==========================================================================

  specialist-assignment:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      (contains(github.event.label.name, 'agent:codegen') ||
       contains(github.event.label.name, 'agent:issue') ||
       contains(github.event.label.name, 'agent:pr'))
    name: Specialist Assignment

    steps:
      - name: Transition to implementing
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.name;

            for (const label of issue.labels.map(l => l.name)) {
              if (label.includes('state:')) {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: issue.number,
                  name: label,
                }).catch(() => {});
              }
            }

            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: issue.number,
              labels: ['state:implementing'],
            });

            console.log(`Issue #${issue.number}: state -> implementing (Specialist agent assigned)`);

  # ==========================================================================
  # 4. PR Created - Start Review
  # ==========================================================================

  pr-created:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    name: PR Created - Start Review

    steps:
      - name: Find linked issue and transition to reviewing
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const match = body.match(/#(\d+)/);

            if (match) {
              const issueNumber = parseInt(match[1], 10);
              const owner = context.repo.owner;
              const repo = context.repo.name;

              // Get current issue labels
              const { data: issue } = await github.rest.issues.get({
                owner, repo,
                issue_number: issueNumber,
              });

              for (const label of issue.labels.map(l => l.name)) {
                if (label.includes('state:')) {
                  await github.rest.issues.removeLabel({
                    owner, repo,
                    issue_number: issueNumber,
                    name: label,
                  }).catch(() => {});
                }
              }

              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: issueNumber,
                labels: ['state:reviewing'],
              });

              console.log(`Issue #${issueNumber}: state -> reviewing (PR #${context.payload.pull_request.number} created)`);
            }

      - name: Add review agent label to PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.pull_request.number,
              labels: ['agent:review', 'state:reviewing']
            });

  # ==========================================================================
  # 5. PR Merged - Mark as Done
  # ==========================================================================

  pr-merged:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    name: PR Merged - Mark Done

    steps:
      - name: Find linked issue and transition to done
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const match = body.match(/#(\d+)/);

            if (match) {
              const issueNumber = parseInt(match[1], 10);
              const owner = context.repo.owner;
              const repo = context.repo.name;

              const { data: issue } = await github.rest.issues.get({
                owner, repo,
                issue_number: issueNumber,
              });

              for (const label of issue.labels.map(l => l.name)) {
                if (label.includes('state:')) {
                  await github.rest.issues.removeLabel({
                    owner, repo,
                    issue_number: issueNumber,
                    name: label,
                  }).catch(() => {});
                }
              }

              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: issueNumber,
                labels: ['state:done'],
              });

              console.log(`Issue #${issueNumber}: state -> done (PR #${context.payload.pull_request.number} merged)`);
            }

  # ==========================================================================
  # 6. Blocked Label - Escalate
  # ==========================================================================

  blocked-escalation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.label.name, 'state:blocked')
    name: Blocked - Escalate

    steps:
      - name: Create escalation comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              body: `**BLOCKED - Guardian Escalation**

            This issue has been marked as blocked and requires Guardian intervention.

            @${{ github.repository_owner }} - Please review and resolve.

            **Next Steps**:
            1. Review blocker reason
            2. Resolve dependencies or technical issues
            3. Remove \`state:blocked\` label when ready
            4. Add appropriate state label to resume

            ---
            *Automated by [State Machine](../.github/workflows/state-machine.yml)*`
            });

      - name: Add severity label
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.payload.issue.number,
              labels: ['priority:P1-High']
            });
